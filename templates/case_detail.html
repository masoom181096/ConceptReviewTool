{% extends "base.html" %}

{% block title %}{{ case.name }} - EBRD Concept Review Tool{% endblock %}

{# Macro to display values with fallback for 0/None/blank #}
{% macro display_val(v, unit="", prefix="", allow_zero=false) -%}
  {% if v is not none and (allow_zero or v != 0) %}
    {{ prefix }}{% if v is number and v >= 1000 %}{{ "{:,.0f}".format(v) }}{% else %}{{ v }}{% endif %}{% if unit %} {{ unit }}{% endif %}
  {% else %}
    —
  {% endif %}
{%- endmacro %}

{% block content %}
<div class="page-header">
    <div>
        <h2>{{ case.name }}</h2>
        <p class="subtitle">{{ case.country }} | {{ case.sector }}</p>
    </div>
    <span class="status-badge status-{{ case.status|lower }} large">{{ case.status }}</span>
</div>

<div class="case-layout">
    <div class="main-column">
        {% if docs.need_assessment_text %}
        <div class="card">
            <h3>Need Assessment (from Email)</h3>
            <div class="email-preview">
                <pre>{{ docs.need_assessment_text[:500] }}{% if docs.need_assessment_text|length > 500 %}...{% endif %}</pre>
            </div>
        </div>
        {% endif %}
        
        <div class="card">
            <h3>Upload Documents</h3>
            <p class="help-text">
                Upload the Sector Profile document and Project Sustainability document. 
                International benchmarks and financial data are provided automatically by the system.
            </p>
            
            <form action="/cases/{{ case.id }}/update_docs" method="post" enctype="multipart/form-data" class="form">
                <div class="doc-section">
                    <div class="doc-header">
                        <label for="sector_profile_text">Sector Profile Document</label>
                        {% if docs.sector_profile_filename %}
                        <span class="file-badge">Uploaded: {{ docs.sector_profile_filename }}</span>
                        {% endif %}
                    </div>
                    <textarea id="sector_profile_text" name="sector_profile_text" rows="4"
                              placeholder="Paste government sector documentation, fleet data, master plan details...">{{ docs.sector_profile_text or '' }}</textarea>
                    <div class="file-input-row">
                        <label class="file-label">Or upload .docx/.txt:</label>
                        <input type="file" name="sector_profile_file" accept=".docx,.txt" class="file-input" />
                    </div>
                </div>
                
                <div class="doc-section">
                    <div class="doc-header">
                        <label for="sustainability_text">Project Characteristics / Sustainability Document</label>
                        {% if docs.sustainability_filename %}
                        <span class="file-badge">Uploaded: {{ docs.sustainability_filename }}</span>
                        {% endif %}
                    </div>
                    <textarea id="sustainability_text" name="sustainability_text" rows="4"
                              placeholder="Paste sustainability/ESG documentation, environmental impact, accessibility plans...">{{ docs.sustainability_text or '' }}</textarea>
                    <div class="file-input-row">
                        <label class="file-label">Or upload .docx/.txt:</label>
                        <input type="file" name="sustainability_file" accept=".docx,.txt" class="file-input" />
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-secondary">Save Documents</button>
                </div>
            </form>
        </div>
        
        <div class="start-review-section">
            <h3>Concept Review Workflow</h3>
            <p>
                Run the multi-phase concept review process. Each phase analyzes different aspects 
                of the project and must complete in sequence.
            </p>
            
            {% set any_phase_started = case.phase1_completed or case.phase2_completed or case.phase3_completed or case.phase4_completed %}
            {% set all_phases_complete = case.phase1_completed and case.phase2_completed and case.phase3_completed and case.phase4_completed %}
            
            <div class="action-buttons" style="justify-content: center; gap: 1rem;">
                {% if not any_phase_started %}
                    <a href="/cases/{{ case.id }}/phases/1" class="btn btn-primary btn-large">
                        Start Concept Review
                    </a>
                {% elif all_phases_complete %}
                    <a href="/cases/{{ case.id }}/review" class="btn btn-success btn-large">
                        Review and Approve Concept Note
                    </a>
                    <a href="/cases/{{ case.id }}/phases/1" class="btn btn-secondary">
                        View Phases
                    </a>
                {% else %}
                    {% if not case.phase1_completed %}
                        <a href="/cases/{{ case.id }}/phases/1" class="btn btn-primary btn-large">
                            Continue: Phase 1
                        </a>
                    {% elif not case.phase2_completed %}
                        <a href="/cases/{{ case.id }}/phases/2" class="btn btn-primary btn-large">
                            Continue: Phase 2
                        </a>
                    {% elif not case.phase3_completed %}
                        <a href="/cases/{{ case.id }}/phases/3" class="btn btn-primary btn-large">
                            Continue: Phase 3
                        </a>
                    {% elif not case.phase4_completed %}
                        <a href="/cases/{{ case.id }}/phases/4" class="btn btn-primary btn-large">
                            Continue: Phase 4
                        </a>
                    {% endif %}
                {% endif %}
                
                {% if concept_note %}
                <a href="/cases/{{ case.id }}/concept_note" class="btn btn-secondary" target="_blank">
                    View Concept Note
                </a>
                {% endif %}
            </div>
            
            {% if any_phase_started %}
            <div style="margin-top: 1.5rem;">
                <p class="help-text" style="margin-bottom: 0.5rem;">Phase Progress:</p>
                <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                    <span class="status-pill {% if case.phase1_completed %}status-completed{% else %}status-pending{% endif %}">
                        Phase 1 {% if case.phase1_completed %}&#10003;{% endif %}
                    </span>
                    <span class="status-pill {% if case.phase2_completed %}status-completed{% else %}status-pending{% endif %}">
                        Phase 2 {% if case.phase2_completed %}&#10003;{% endif %}
                    </span>
                    <span class="status-pill {% if case.phase3_completed %}status-completed{% else %}status-pending{% endif %}">
                        Phase 3 {% if case.phase3_completed %}&#10003;{% endif %}
                    </span>
                    <span class="status-pill {% if case.phase4_completed %}status-completed{% else %}status-pending{% endif %}">
                        Phase 4 {% if case.phase4_completed %}&#10003;{% endif %}
                    </span>
                </div>
            </div>
            {% endif %}
            
            {% if any_phase_started %}
            <div style="margin-top: 1rem;">
                <form action="/cases/{{ case.id }}/reset_phases" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-secondary" 
                            onclick="return confirm('Are you sure you want to reset all phases? This will clear all analysis results.');">
                        Reset All Phases
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
        
        {% if thinking_steps %}
        <div class="card thinking-card" id="saved-thinking-section">
            <h3>Agent Thinking / Background Steps</h3>
            <p class="help-text">The agent performed the following reasoning steps:</p>
            <div class="thinking-log">
                {% for step in thinking_steps %}
                <div class="thinking-step visible">
                    <div class="step-header">
                        <span class="step-number">Step {{ step.step }}</span>
                        <span class="step-title">{{ step.title }}</span>
                    </div>
                    <p class="step-description">{{ step.description|replace('\n', '<br>')|safe }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if sector_profile %}
        <div class="card">
            <h3>Sector Profile</h3>
            <table class="data-table compact">
                <tr><th>Total Fleet</th><td>{{ display_val(sector_profile.fleet_total, "buses") }}</td></tr>
                <tr><th>Diesel Buses</th><td>{{ display_val(sector_profile.fleet_diesel) }}</td></tr>
                <tr><th>Hybrid Buses</th><td>{{ display_val(sector_profile.fleet_hybrid) }}</td></tr>
                <tr><th>Electric Buses</th><td>{{ display_val(sector_profile.fleet_electric, allow_zero=true) }}</td></tr>
                <tr><th>Depots</th><td>{{ display_val(sector_profile.depots) }}</td></tr>
                <tr><th>Daily Ridership</th><td>{{ display_val(sector_profile.daily_ridership, "passengers/day") }}</td></tr>
                <tr><th>Annual OPEX</th><td>{{ display_val(sector_profile.annual_opex_usd, prefix="$") }}</td></tr>
                <tr><th>Annual CO2</th><td>{{ display_val(sector_profile.annual_co2_tons, "tons/year") }}</td></tr>
            </table>
            {% if sector_profile.notes %}
            <p class="notes"><strong>Notes:</strong> {{ sector_profile.notes }}</p>
            {% endif %}
        </div>
        {% endif %}
        
        {% if gap_items %}
        <div class="card">
            <h3>Gap Analysis vs International Benchmarks</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Indicator</th>
                        <th>{{ case.country }} Value</th>
                        <th>Benchmark City</th>
                        <th>Benchmark Value</th>
                        <th>Gap</th>
                        <th>Comparability</th>
                    </tr>
                </thead>
                <tbody>
                    {% for gap in gap_items %}
                    <tr>
                        <td>{{ gap.indicator }}</td>
                        <td>{{ gap.kenya_value }}</td>
                        <td>{{ gap.benchmark_city }}</td>
                        <td>{{ gap.benchmark_value }}</td>
                        <td>{{ gap.gap_delta }}</td>
                        <td><span class="comparability-{{ gap.comparability }}">{{ gap.comparability }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        {% if kpis %}
        <div class="card">
            <h3>Baseline KPIs</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>KPI</th>
                        <th>Baseline</th>
                        <th>Unit</th>
                        <th>Target</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
                    {% for kpi in kpis %}
                    <tr>
                        <td>{{ kpi.name }}</td>
                        <td>{{ kpi.baseline_value }}</td>
                        <td>{{ kpi.unit }}</td>
                        <td>{{ kpi.target_value }}</td>
                        <td><span class="category-badge">{{ kpi.category }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        {% if financial_options %}
        <div class="card">
            <h3>Financial Options (Ranked by Total Score)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Option</th>
                        <th>Principal</th>
                        <th>Tenor</th>
                        <th>Rate (bps)</th>
                        <th>Repayment Score</th>
                        <th>Rate Score</th>
                        <th>Total Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for opt in financial_options %}
                    <tr class="{% if loop.first %}highlight-row{% endif %}">
                        <td><strong>{{ opt.name }}</strong></td>
                        <td>${{ "{:,.0f}".format(opt.principal_amount_usd / 1000000) }}M</td>
                        <td>{{ opt.tenor_years }}y ({{ opt.grace_period_years }}y grace)</td>
                        <td>{{ opt.all_in_rate_bps }}</td>
                        <td class="score">{{ opt.repayment_score }}</td>
                        <td class="score">{{ opt.rate_score }}</td>
                        <td class="score total-score">{{ opt.total_score }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p class="help-text">Scoring: 60% Repayment Capacity + 40% Rate Competitiveness</p>
        </div>
        {% endif %}
        
        {% if sustainability %}
        <div class="card">
            <h3>Sustainability Profile</h3>
            <table class="data-table compact">
                <tr>
                    <th>E&S Category</th>
                    <td>{% if sustainability.category %}<span class="category-badge category-{{ sustainability.category }}">Category {{ sustainability.category }}</span>{% else %}—{% endif %}</td>
                </tr>
                <tr><th>CO2 Reduction</th><td>{{ display_val(sustainability.co2_reduction_tons, "tons/year") }}</td></tr>
                <tr><th>PM2.5 Reduction</th><td>{{ sustainability.pm25_reduction or '—' }}</td></tr>
            </table>
            <div class="sustainability-details">
                <p><strong>Accessibility:</strong> {{ sustainability.accessibility_notes or '—' }}</p>
                <p><strong>Policy Alignment:</strong> {{ sustainability.policy_alignment_notes or '—' }}</p>
                <p><strong>Key Risks:</strong> {{ sustainability.key_risks or '—' }}</p>
                <p><strong>Mitigations:</strong> {{ sustainability.mitigations or '—' }}</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="side-column">
        <div class="card">
            <h3>Case Information</h3>
            <dl class="info-list">
                <dt>Case ID</dt>
                <dd>{{ case.id }}</dd>
                <dt>Status</dt>
                <dd><span class="status-badge status-{{ case.status|lower }}">{{ case.status }}</span></dd>
                <dt>Created</dt>
                <dd>{{ case.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                <dt>Updated</dt>
                <dd>{{ case.updated_at.strftime('%Y-%m-%d %H:%M') }}</dd>
            </dl>
        </div>
    </div>
</div>

{% endblock %}
