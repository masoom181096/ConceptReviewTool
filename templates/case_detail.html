{% extends "base.html" %}

{% block title %}{{ case.name }} - EBRD Concept Review Tool{% endblock %}

{# Macro to display values with fallback for 0/None/blank #}
{% macro display_val(v, unit="", prefix="", allow_zero=false) -%}
  {% if v is not none and (allow_zero or v != 0) %}
    {{ prefix }}{% if v is number and v >= 1000 %}{{ "{:,.0f}".format(v) }}{% else %}{{ v }}{% endif %}{% if unit %} {{ unit }}{% endif %}
  {% else %}
    —
  {% endif %}
{%- endmacro %}

{% block content %}
<div class="page-header">
    <div>
        <h2>{{ case.name }}</h2>
        <p class="subtitle">{{ case.country }} | {{ case.sector }}</p>
    </div>
    <span class="status-badge status-{{ case.status|lower }} large">{{ case.status }}</span>
</div>

<div class="case-layout">
    <div class="main-column">
        {% if docs.need_assessment_text %}
        <div class="card">
            <h3>Need Assessment (from Email)</h3>
            <div class="email-preview">
                <pre>{{ docs.need_assessment_text[:500] }}{% if docs.need_assessment_text|length > 500 %}...{% endif %}</pre>
            </div>
        </div>
        {% endif %}
        
        <div class="card">
            <h3>Upload Documents</h3>
            <p class="help-text">
                Upload the Sector Profile document and Project Sustainability document. 
                International benchmarks and financial data are provided automatically by the system.
            </p>
            
            <form action="/cases/{{ case.id }}/update_docs" method="post" enctype="multipart/form-data" class="form">
                <div class="doc-section">
                    <div class="doc-header">
                        <label for="sector_profile_text">Sector Profile Document</label>
                        {% if docs.sector_profile_filename %}
                        <span class="file-badge">Uploaded: {{ docs.sector_profile_filename }}</span>
                        {% endif %}
                    </div>
                    <textarea id="sector_profile_text" name="sector_profile_text" rows="4"
                              placeholder="Paste government sector documentation, fleet data, master plan details...">{{ docs.sector_profile_text or '' }}</textarea>
                    <div class="file-input-row">
                        <label class="file-label">Or upload .docx/.txt:</label>
                        <input type="file" name="sector_profile_file" accept=".docx,.txt" class="file-input" />
                    </div>
                </div>
                
                <div class="doc-section">
                    <div class="doc-header">
                        <label for="sustainability_text">Project Characteristics / Sustainability Document</label>
                        {% if docs.sustainability_filename %}
                        <span class="file-badge">Uploaded: {{ docs.sustainability_filename }}</span>
                        {% endif %}
                    </div>
                    <textarea id="sustainability_text" name="sustainability_text" rows="4"
                              placeholder="Paste sustainability/ESG documentation, environmental impact, accessibility plans...">{{ docs.sustainability_text or '' }}</textarea>
                    <div class="file-input-row">
                        <label class="file-label">Or upload .docx/.txt:</label>
                        <input type="file" name="sustainability_file" accept=".docx,.txt" class="file-input" />
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-secondary">Save Documents</button>
                </div>
            </form>
        </div>
        
        <div class="card">
            <h3>Agent Actions</h3>
            <div class="action-buttons">
                <button id="run-agent-btn" type="button" class="btn btn-primary btn-large">
                    Run Concept Review Agent
                </button>
                
                <a href="/cases/{{ case.id }}/concept_note" id="view-concept-note-btn" 
                   class="btn btn-secondary btn-large {% if not concept_note %}hidden{% endif %}"
                   target="_blank">
                    View Concept Note
                </a>
            </div>
            <p class="help-text" style="margin-top: 1rem;">
                The agent will analyze documents, compare with international benchmarks, 
                calculate financial options, and generate a Concept Note.
            </p>
        </div>
        
        <section id="agent-thinking-section" class="card thinking-card" style="display: none;">
            <h3>
                <span id="thinking-header-text">Agent Thinking...</span>
                <span id="thinking-spinner" class="spinner"></span>
            </h3>
            <p class="help-text">Watch the agent reason through each step:</p>
            <div id="thinking-steps" class="thinking-log"></div>
            <div id="thinking-complete" style="display: none; margin-top: 1rem;">
                <p class="success-message">Analysis complete! Results saved to database.</p>
                <div class="action-buttons" style="margin-top: 1rem;">
                    <a href="/cases/{{ case.id }}/review" class="btn btn-primary">
                        Proceed to Review and Approve Concept Note
                    </a>
                    <button onclick="location.reload()" class="btn btn-secondary">
                        Refresh Page to See Results
                    </button>
                </div>
            </div>
        </section>
        
        {% if thinking_steps %}
        <div class="card thinking-card" id="saved-thinking-section">
            <h3>Agent Thinking / Background Steps</h3>
            <p class="help-text">The agent performed the following reasoning steps:</p>
            <div class="thinking-log">
                {% for step in thinking_steps %}
                <div class="thinking-step visible">
                    <div class="step-header">
                        <span class="step-number">Step {{ step.step }}</span>
                        <span class="step-title">{{ step.title }}</span>
                    </div>
                    <p class="step-description">{{ step.description|replace('\n', '<br>')|safe }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if sector_profile %}
        <div class="card">
            <h3>Sector Profile</h3>
            <table class="data-table compact">
                <tr><th>Total Fleet</th><td>{{ display_val(sector_profile.fleet_total, "buses") }}</td></tr>
                <tr><th>Diesel Buses</th><td>{{ display_val(sector_profile.fleet_diesel) }}</td></tr>
                <tr><th>Hybrid Buses</th><td>{{ display_val(sector_profile.fleet_hybrid) }}</td></tr>
                <tr><th>Electric Buses</th><td>{{ display_val(sector_profile.fleet_electric, allow_zero=true) }}</td></tr>
                <tr><th>Depots</th><td>{{ display_val(sector_profile.depots) }}</td></tr>
                <tr><th>Daily Ridership</th><td>{{ display_val(sector_profile.daily_ridership, "passengers/day") }}</td></tr>
                <tr><th>Annual OPEX</th><td>{{ display_val(sector_profile.annual_opex_usd, prefix="$") }}</td></tr>
                <tr><th>Annual CO2</th><td>{{ display_val(sector_profile.annual_co2_tons, "tons/year") }}</td></tr>
            </table>
            {% if sector_profile.notes %}
            <p class="notes"><strong>Notes:</strong> {{ sector_profile.notes }}</p>
            {% endif %}
        </div>
        {% endif %}
        
        {% if gap_items %}
        <div class="card">
            <h3>Gap Analysis vs International Benchmarks</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Indicator</th>
                        <th>{{ case.country }} Value</th>
                        <th>Benchmark City</th>
                        <th>Benchmark Value</th>
                        <th>Gap</th>
                        <th>Comparability</th>
                    </tr>
                </thead>
                <tbody>
                    {% for gap in gap_items %}
                    <tr>
                        <td>{{ gap.indicator }}</td>
                        <td>{{ gap.kenya_value }}</td>
                        <td>{{ gap.benchmark_city }}</td>
                        <td>{{ gap.benchmark_value }}</td>
                        <td>{{ gap.gap_delta }}</td>
                        <td><span class="comparability-{{ gap.comparability }}">{{ gap.comparability }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        {% if kpis %}
        <div class="card">
            <h3>Baseline KPIs</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>KPI</th>
                        <th>Baseline</th>
                        <th>Unit</th>
                        <th>Target</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
                    {% for kpi in kpis %}
                    <tr>
                        <td>{{ kpi.name }}</td>
                        <td>{{ kpi.baseline_value }}</td>
                        <td>{{ kpi.unit }}</td>
                        <td>{{ kpi.target_value }}</td>
                        <td><span class="category-badge">{{ kpi.category }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        {% if financial_options %}
        <div class="card">
            <h3>Financial Options (Ranked by Total Score)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Option</th>
                        <th>Principal</th>
                        <th>Tenor</th>
                        <th>Rate (bps)</th>
                        <th>Repayment Score</th>
                        <th>Rate Score</th>
                        <th>Total Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for opt in financial_options %}
                    <tr class="{% if loop.first %}highlight-row{% endif %}">
                        <td><strong>{{ opt.name }}</strong></td>
                        <td>${{ "{:,.0f}".format(opt.principal_amount_usd / 1000000) }}M</td>
                        <td>{{ opt.tenor_years }}y ({{ opt.grace_period_years }}y grace)</td>
                        <td>{{ opt.all_in_rate_bps }}</td>
                        <td class="score">{{ opt.repayment_score }}</td>
                        <td class="score">{{ opt.rate_score }}</td>
                        <td class="score total-score">{{ opt.total_score }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p class="help-text">Scoring: 60% Repayment Capacity + 40% Rate Competitiveness</p>
        </div>
        {% endif %}
        
        {% if sustainability %}
        <div class="card">
            <h3>Sustainability Profile</h3>
            <table class="data-table compact">
                <tr>
                    <th>E&S Category</th>
                    <td>{% if sustainability.category %}<span class="category-badge category-{{ sustainability.category }}">Category {{ sustainability.category }}</span>{% else %}—{% endif %}</td>
                </tr>
                <tr><th>CO2 Reduction</th><td>{{ display_val(sustainability.co2_reduction_tons, "tons/year") }}</td></tr>
                <tr><th>PM2.5 Reduction</th><td>{{ sustainability.pm25_reduction or '—' }}</td></tr>
            </table>
            <div class="sustainability-details">
                <p><strong>Accessibility:</strong> {{ sustainability.accessibility_notes or '—' }}</p>
                <p><strong>Policy Alignment:</strong> {{ sustainability.policy_alignment_notes or '—' }}</p>
                <p><strong>Key Risks:</strong> {{ sustainability.key_risks or '—' }}</p>
                <p><strong>Mitigations:</strong> {{ sustainability.mitigations or '—' }}</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="side-column">
        <div class="card">
            <h3>Case Information</h3>
            <dl class="info-list">
                <dt>Case ID</dt>
                <dd>{{ case.id }}</dd>
                <dt>Status</dt>
                <dd><span class="status-badge status-{{ case.status|lower }}">{{ case.status }}</span></dd>
                <dt>Created</dt>
                <dd>{{ case.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                <dt>Updated</dt>
                <dd>{{ case.updated_at.strftime('%Y-%m-%d %H:%M') }}</dd>
            </dl>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const runAgentBtn = document.getElementById('run-agent-btn');
    const thinkingSection = document.getElementById('agent-thinking-section');
    const thinkingStepsContainer = document.getElementById('thinking-steps');
    const thinkingComplete = document.getElementById('thinking-complete');
    const thinkingSpinner = document.getElementById('thinking-spinner');
    const thinkingHeaderText = document.getElementById('thinking-header-text');
    const viewConceptNoteBtn = document.getElementById('view-concept-note-btn');
    const savedThinkingSection = document.getElementById('saved-thinking-section');
    
    const caseId = {{ case.id }};
    
    runAgentBtn.addEventListener('click', async function() {
        runAgentBtn.disabled = true;
        runAgentBtn.textContent = 'Running...';
        
        if (savedThinkingSection) {
            savedThinkingSection.style.display = 'none';
        }
        
        thinkingSection.style.display = 'block';
        thinkingStepsContainer.innerHTML = '';
        thinkingComplete.style.display = 'none';
        thinkingSpinner.style.display = 'inline-block';
        thinkingHeaderText.textContent = 'Agent Thinking...';
        
        try {
            const response = await fetch(`/api/cases/${caseId}/run_concept_review`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                await displayThinkingSteps(data.thinking_steps);
                
                thinkingSpinner.style.display = 'none';
                thinkingHeaderText.textContent = 'Agent Thinking Complete';
                thinkingComplete.style.display = 'block';
                
                viewConceptNoteBtn.classList.remove('hidden');
                
                runAgentBtn.textContent = 'Run Again';
                runAgentBtn.disabled = false;
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        } catch (error) {
            console.error('Error running concept review:', error);
            thinkingSpinner.style.display = 'none';
            thinkingHeaderText.textContent = 'Error';
            thinkingStepsContainer.innerHTML = `
                <div class="thinking-step error visible">
                    <div class="step-header">
                        <span class="step-number">Error</span>
                        <span class="step-title">Failed to run concept review</span>
                    </div>
                    <p class="step-description">${error.message}</p>
                </div>
            `;
            runAgentBtn.textContent = 'Try Again';
            runAgentBtn.disabled = false;
        }
    });
    
    async function displayThinkingSteps(steps) {
        for (let i = 0; i < steps.length; i++) {
            const step = steps[i];
            
            const stepEl = document.createElement('div');
            stepEl.className = 'thinking-step';
            stepEl.innerHTML = `
                <div class="step-header">
                    <span class="step-number">Step ${step.step}</span>
                    <span class="step-title">${step.title}</span>
                </div>
                <p class="step-description"></p>
            `;
            thinkingStepsContainer.appendChild(stepEl);
            
            await sleep(300);
            stepEl.classList.add('visible');
            
            const descEl = stepEl.querySelector('.step-description');
            await typeText(descEl, step.description, 15);
            
            stepEl.classList.add('typing-complete');
            
            if (i < steps.length - 1) {
                await sleep(800);
            }
        }
    }
    
    function typeText(element, text, speed) {
        return new Promise((resolve) => {
            let index = 0;
            const interval = setInterval(() => {
                if (index < text.length) {
                    element.textContent += text.charAt(index);
                    index++;
                } else {
                    clearInterval(interval);
                    resolve();
                }
            }, speed);
        });
    }
    
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
});
</script>
{% endblock %}
