{% extends "base.html" %}
{% from "_progress_bar.html" import phase_progress, phase_progress_vertical %}

{% macro display_val(value, suffix='', allow_zero=false) %}
  {% if value is not none and (value != 0 or allow_zero) %}
    {% if value is number %}
      {{ "{:,}".format(value|int) }}{% if suffix %} {{ suffix }}{% endif %}
    {% else %}
      {{ value }}{% if suffix %} {{ suffix }}{% endif %}
    {% endif %}
  {% else %}
    —
  {% endif %}
{% endmacro %}

{% block title %}Phase {{ phase_no }} - {{ phase_info[phase_no].title }} | {{ case.name }}{% endblock %}

{% block content %}
<div class="phase-layout">
    <!-- Left Sidebar -->
    <div class="phase-sidebar">
        <!-- Vertical Progress Bar -->
        {{ phase_progress_vertical(case, phase_no) }}
        
        <!-- Case Summary Card -->
        <div class="case-summary-card">
            <h3>{{ case.name }}</h3>
            <div class="case-summary-meta">{{ case.country }} | {{ case.sector }}</div>
            {% set phase_completed = (phase_no == 1 and case.phase1_completed) or (phase_no == 2 and case.phase2_completed) or (phase_no == 3 and case.phase3_completed) or (phase_no == 4 and case.phase4_completed) %}
            {% if phase_completed %}
                <span class="status-pill status-completed">Phase {{ phase_no }} Completed</span>
            {% else %}
                <span class="status-pill status-pending">In Progress</span>
            {% endif %}
            <div class="case-summary-dates">
                <div><strong>Created:</strong> {{ case.created_at.strftime('%b %d, %Y') if case.created_at else '—' }}</div>
                <div><strong>Updated:</strong> {{ case.updated_at.strftime('%b %d, %Y') if case.updated_at else '—' }}</div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="phase-main">
        <div class="phase-main-card">
            <div class="phase-title-section">
                <h2>Phase {{ phase_no }} – {{ phase_info[phase_no].title }}</h2>
                {% if phase_completed %}
                    <span class="status-pill status-completed">Completed</span>
                {% else %}
                    <span class="status-pill status-pending">Not Started</span>
                {% endif %}
            </div>
            
            <!-- Tabbed Interface -->
            <div class="phase-tabs">
                <button class="tab-button active" data-tab="thinking">Agent Thinking</button>
                <button class="tab-button" data-tab="outputs">Outputs</button>
            </div>
            
            <!-- Agent Thinking Tab -->
            <div class="tab-panel active" id="tab-thinking">
                <div class="card">
                    <h3>Inputs Summary</h3>
                    {% if phase_no == 1 %}
                    <p class="input-description">
                        The agent will parse the Sector Profile document, compare it with international benchmarks 
                        (Shenzhen, London, Santiago), and construct baseline KPIs for the pilot project.
                    </p>
                    {% if docs.sector_profile_filename %}
                        <p><strong>Document:</strong> {{ docs.sector_profile_filename }}</p>
                    {% elif docs.sector_profile_text %}
                        <p><strong>Document:</strong> Text input provided</p>
                        <div class="doc-preview">{{ docs.sector_profile_text[:300] }}{% if docs.sector_profile_text|length > 300 %}...{% endif %}</div>
                    {% else %}
                        <p class="warning-text">No sector profile document uploaded yet. <a href="/cases/{{ case.id }}">Upload documents</a></p>
                    {% endif %}
                    {% elif phase_no == 2 %}
                    <p class="input-description">
                        The agent will assess the project's sustainability characteristics using the uploaded 
                        sustainability document, including E&S classification, emissions reduction, and risk analysis.
                    </p>
                    {% if docs.sustainability_filename %}
                        <p><strong>Document:</strong> {{ docs.sustainability_filename }}</p>
                    {% elif docs.sustainability_text %}
                        <p><strong>Document:</strong> Text input provided</p>
                        <div class="doc-preview">{{ docs.sustainability_text[:300] }}{% if docs.sustainability_text|length > 300 %}...{% endif %}</div>
                    {% else %}
                        <p class="warning-text">No sustainability document uploaded yet. <a href="/cases/{{ case.id }}">Upload documents</a></p>
                    {% endif %}
                    {% elif phase_no == 3 %}
                    <p class="input-description">
                        This phase uses stubbed Bloomberg data and repayment heuristics to propose three 
                        financing structures with 60/40 scoring (60% repayment capacity, 40% rate competitiveness).
                    </p>
                    {% elif phase_no == 4 %}
                    <p class="input-description">
                        The agent will assemble all previous phase outputs into a comprehensive Concept Note 
                        draft for OPSComm review, summarizing the need, context, KPIs, financing options, 
                        and sustainability assessment.
                    </p>
                    {% endif %}
                </div>
                
                <div class="thinking-container">
                    <div id="thinking-status" class="thinking-status hidden"></div>
                    
                    {% if thinking_steps %}
                    <div class="card">
                        <h3>Agent Reasoning</h3>
                        <div class="thinking-timeline" id="thinking-timeline">
                            {% for step in thinking_steps %}
                            <div class="thinking-step typing-complete">
                                <div class="step-header">
                                    <span class="step-badge">Step {{ step.step }}</span>
                                    <strong>{{ step.title }}</strong>
                                </div>
                                <div class="step-description">{{ step.description|replace('\n', '<br>')|safe }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="thinking-empty-state" id="thinking-empty">
                        <p>No agent reasoning recorded yet.</p>
                        {% set prev_phase_completed = (phase_no == 1) or (phase_no == 2 and case.phase1_completed) or (phase_no == 3 and case.phase2_completed) or (phase_no == 4 and case.phase3_completed) %}
                        {% if not phase_completed and prev_phase_completed %}
                        <p>Click "Run Phase {{ phase_no }}" to start the analysis.</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Run Phase Action (stays in Agent Thinking tab) -->
                {% set prev_phase_completed = (phase_no == 1) or (phase_no == 2 and case.phase1_completed) or (phase_no == 3 and case.phase2_completed) or (phase_no == 4 and case.phase3_completed) %}
                {% if not phase_completed and prev_phase_completed %}
                <div class="run-phase-action">
                    <button 
                        id="run-phase-btn" 
                        type="button" 
                        class="btn btn-primary btn-large"
                        data-case-id="{{ case.id }}"
                        data-phase="{{ phase_no }}"
                    >
                        Run Phase {{ phase_no }}
                    </button>
                </div>
                {% elif not prev_phase_completed %}
                <div class="run-phase-action">
                    <span class="btn btn-disabled">Complete Phase {{ phase_no - 1 }} first</span>
                </div>
                {% endif %}
            </div>
            
            <!-- Outputs Tab -->
            <div class="tab-panel" id="tab-outputs">
                <div class="outputs-container">
                    {% if phase_no == 1 %}
                    <!-- PHASE 1: Sector Profile, Gap Analysis & KPIs -->
                    {% if sector_profile %}
                    <div class="card">
                        <h3>Sector Profile</h3>
                        <table class="data-table">
                            <tr><th>Total Fleet</th><td>{{ display_val(sector_profile.fleet_total, "buses") }}</td></tr>
                            <tr><th>Diesel Buses</th><td>{{ display_val(sector_profile.fleet_diesel) }}</td></tr>
                            <tr><th>Hybrid Buses</th><td>{{ display_val(sector_profile.fleet_hybrid) }}</td></tr>
                            <tr><th>Electric Buses</th><td>{{ display_val(sector_profile.fleet_electric, '', true) }}</td></tr>
                            <tr><th>Depots</th><td>{{ display_val(sector_profile.depots) }}</td></tr>
                            <tr><th>Daily Ridership</th><td>{{ display_val(sector_profile.daily_ridership, "passengers/day") }}</td></tr>
                            <tr><th>Annual OPEX</th><td>{% if sector_profile.annual_opex_usd %}${{ "{:,.0f}".format(sector_profile.annual_opex_usd) }}{% else %}—{% endif %}</td></tr>
                            <tr><th>Annual CO2</th><td>{{ display_val(sector_profile.annual_co2_tons, "tons/year") }}</td></tr>
                        </table>
                    </div>
                    {% endif %}
                    
                    {% if gap_items %}
                    <div class="card">
                        <h3>Gap Analysis</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Indicator</th>
                                    <th>{{ case.country }} Value</th>
                                    <th>Benchmark City</th>
                                    <th>Benchmark Value</th>
                                    <th>Gap</th>
                                    <th>Priority</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for gap in gap_items %}
                                <tr>
                                    <td>{{ gap.indicator }}</td>
                                    <td>{{ gap.kenya_value or '—' }}</td>
                                    <td>{{ gap.benchmark_city or '—' }}</td>
                                    <td>{{ gap.benchmark_value or '—' }}</td>
                                    <td>{{ gap.gap_delta or '—' }}</td>
                                    <td><span class="priority-badge priority-{{ gap.comparability|lower }}">{{ gap.comparability }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    {% if kpis %}
                    <div class="card">
                        <h3>Baseline KPIs</h3>
                        <table class="data-table" id="kpi-table">
                            <thead>
                                <tr>
                                    <th>KPI Name</th>
                                    <th>Baseline</th>
                                    <th>Target</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for kpi in kpis %}
                                <tr title="{{ kpi.notes or 'Key Performance Indicator: ' + kpi.name }}">
                                    <td>{{ kpi.name }}</td>
                                    <td>{{ kpi.baseline_value or '—' }}</td>
                                    <td>{{ kpi.target_value or '—' }}</td>
                                    <td>{{ kpi.unit or '—' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    {% if not sector_profile and not gap_items and not kpis %}
                    <div class="thinking-empty-state">
                        <p>No outputs generated yet. Run Phase 1 to generate sector analysis.</p>
                    </div>
                    {% endif %}
                    
                    {% elif phase_no == 2 %}
                    <!-- PHASE 2: Sustainability Assessment -->
                    {% if sustainability %}
                    <div class="card">
                        <h3>Sustainability Profile</h3>
                        <table class="data-table">
                            <tr>
                                <th>E&S Category</th>
                                <td>
                                    {% if sustainability.category %}
                                        <span class="category-badge category-{{ sustainability.category }}">Category {{ sustainability.category }}</span>
                                    {% else %}—{% endif %}
                                </td>
                            </tr>
                            <tr><th>CO2 Reduction</th><td>{{ display_val(sustainability.co2_reduction_tons, "tons/year") }}</td></tr>
                            <tr><th>PM2.5 Reduction</th><td>{{ sustainability.pm25_reduction or '—' }}</td></tr>
                        </table>
                        <div class="sustainability-details">
                            <p><strong>Accessibility:</strong> {{ sustainability.accessibility_notes or '—' }}</p>
                            <p><strong>Policy Alignment:</strong> {{ sustainability.policy_alignment_notes or '—' }}</p>
                            <p><strong>Key Risks:</strong> {{ sustainability.key_risks or '—' }}</p>
                            <p><strong>Mitigations:</strong> {{ sustainability.mitigations or '—' }}</p>
                        </div>
                    </div>
                    {% else %}
                    <div class="thinking-empty-state">
                        <p>No outputs generated yet. Run Phase 2 to generate sustainability assessment.</p>
                    </div>
                    {% endif %}
                    
                    {% elif phase_no == 3 %}
                    <!-- PHASE 3: Market Data & Financial Options -->
                    {% if market_data %}
                    <div class="card">
                        <h3>Market Data Snapshot</h3>
                        <table class="data-table compact">
                            <tr><th>EUR 10Y Swap</th><td>{{ market_data.eur_swap_10y_pct }}%</td></tr>
                            <tr><th>Green Bond Spread (10Y)</th><td>{{ market_data.green_bond_spread_10y_pct }}%</td></tr>
                            <tr><th>All-in Green Rate</th><td>{{ market_data.all_in_green_rate_pct }}%</td></tr>
                        </table>
                    </div>
                    {% endif %}
                    
                    {% if financial_options %}
                    <div class="card">
                        <h3>Financial Options</h3>
                        <p class="input-description">Click on a row to view detailed information about each financing option.</p>
                        <table class="data-table financial-options-table table-clickable" id="financial-options-table">
                            <thead>
                                <tr>
                                    <th>Option</th>
                                    <th>Structure</th>
                                    <th>Tenor/Grace</th>
                                    <th>Rate</th>
                                    <th>Repayment Score</th>
                                    <th>Rate Score</th>
                                    <th>Total Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for opt in financial_options %}
                                <tr data-option-json='{{ {"name": opt.name, "principal": opt.principal_amount_usd, "tenor": opt.tenor_years, "grace": opt.grace_period_years, "rate": (opt.all_in_rate_bps / 100)|round(2) if opt.all_in_rate_bps else null, "repayment_score": opt.repayment_score|round(1) if opt.repayment_score else null, "rate_score": opt.rate_score|round(1) if opt.rate_score else null, "total_score": opt.total_score|round(1) if opt.total_score else null, "pros": opt.pros, "cons": opt.cons}|tojson }}'>
                                    <td><strong>Option {{ loop.index | string | replace('1', 'A') | replace('2', 'B') | replace('3', 'C') }}</strong></td>
                                    <td>{{ opt.name }}</td>
                                    <td>{{ opt.tenor_years or '—' }}y / {{ opt.grace_period_years or '—' }}y</td>
                                    <td>{% if opt.all_in_rate_bps %}{{ (opt.all_in_rate_bps / 100)|round(2) }}%{% else %}—{% endif %}</td>
                                    <td>{{ opt.repayment_score|round(1) if opt.repayment_score else '—' }}</td>
                                    <td>{{ opt.rate_score|round(1) if opt.rate_score else '—' }}</td>
                                    <td><strong>{{ opt.total_score|round(1) if opt.total_score else '—' }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        <!-- Option Detail Drawer -->
                        <div id="option-detail-drawer" class="option-detail-card hidden">
                            <h4 id="option-detail-title">Option Details</h4>
                            <div class="option-detail-grid">
                                <div class="option-detail-item">
                                    <div class="label">Principal Amount</div>
                                    <div class="value" id="detail-principal">—</div>
                                </div>
                                <div class="option-detail-item">
                                    <div class="label">Tenor</div>
                                    <div class="value" id="detail-tenor">—</div>
                                </div>
                                <div class="option-detail-item">
                                    <div class="label">Grace Period</div>
                                    <div class="value" id="detail-grace">—</div>
                                </div>
                                <div class="option-detail-item">
                                    <div class="label">Interest Rate</div>
                                    <div class="value" id="detail-rate">—</div>
                                </div>
                                <div class="option-detail-item">
                                    <div class="label">Repayment Score</div>
                                    <div class="value" id="detail-repayment">—</div>
                                </div>
                                <div class="option-detail-item">
                                    <div class="label">Rate Score</div>
                                    <div class="value" id="detail-rate-score">—</div>
                                </div>
                                <div class="option-detail-item">
                                    <div class="label">Total Score</div>
                                    <div class="value" id="detail-total">—</div>
                                </div>
                            </div>
                            <div class="option-pros-cons-grid">
                                <div class="option-pros-section">
                                    <h5>Benefits</h5>
                                    <p id="detail-pros">—</p>
                                </div>
                                <div class="option-cons-section">
                                    <h5>Trade-offs</h5>
                                    <p id="detail-cons">—</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="thinking-empty-state">
                        <p>No outputs generated yet. Run Phase 3 to generate financial options.</p>
                    </div>
                    {% endif %}
                    
                    {% elif phase_no == 4 %}
                    <!-- PHASE 4: Concept Note Draft -->
                    {% if concept_note_html %}
                    <div class="card concept-note-preview">
                        <h3>Concept Note Preview</h3>
                        <div class="concept-note-content">
                            {{ concept_note_html|safe }}
                        </div>
                    </div>
                    {% else %}
                    <div class="thinking-empty-state">
                        <p>No outputs generated yet. Run Phase 4 to generate the concept note.</p>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            
            <!-- Phase Navigation Footer (always visible, outside tabs) -->
            <div class="phase-footer">
                <div class="phase-footer-left">
                    <a href="/cases/{{ case.id }}" class="back-link">&larr; Back to Case Overview</a>
                </div>
                <div class="phase-footer-right">
                    {% if phase_no > 1 %}
                        <a href="/cases/{{ case.id }}/phases/{{ phase_no - 1 }}" class="btn btn-secondary">&larr; Phase {{ phase_no - 1 }}</a>
                    {% endif %}
                    
                    {% if phase_no < 4 %}
                        {% if phase_completed %}
                            <a href="/cases/{{ case.id }}/phases/{{ phase_no + 1 }}" class="btn btn-success" id="proceed-btn">Proceed to Phase {{ phase_no + 1 }} &rarr;</a>
                        {% else %}
                            <button type="button" class="btn btn-disabled" id="proceed-btn-disabled" disabled title="Run this phase first">Proceed to Phase {{ phase_no + 1 }} &rarr;</button>
                        {% endif %}
                    {% else %}
                        {% if phase_completed %}
                            <a href="/cases/{{ case.id }}/review" class="btn btn-success" id="proceed-btn">Review & Approve &rarr;</a>
                        {% else %}
                            <button type="button" class="btn btn-disabled" id="proceed-btn-disabled" disabled title="Run this phase first">Review & Approve &rarr;</button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<script>
(function() {
    // Toast Notification System
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        
        const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
        toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 2500);
    }
    
    window.showToast = showToast;
    
    // Tab Switching
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');
    
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.getAttribute('data-tab');
            
            tabButtons.forEach(b => b.classList.remove('active'));
            tabPanels.forEach(p => p.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById('tab-' + targetTab).classList.add('active');
        });
    });
    
    // Financial Options Interactive Table (Phase 3)
    const optionsTable = document.getElementById('financial-options-table');
    if (optionsTable) {
        const rows = optionsTable.querySelectorAll('tbody tr');
        const drawer = document.getElementById('option-detail-drawer');
        
        rows.forEach((row, idx) => {
            row.addEventListener('click', () => {
                rows.forEach(r => r.classList.remove('row-selected'));
                row.classList.add('row-selected');
                
                const optionData = JSON.parse(row.getAttribute('data-option-json'));
                
                const optionLetter = ['A', 'B', 'C'][idx] || (idx + 1);
                document.getElementById('option-detail-title').textContent = 
                    'Option ' + optionLetter + ': ' + (optionData.name || 'Details');
                
                document.getElementById('detail-principal').textContent = 
                    optionData.principal ? '$' + optionData.principal.toLocaleString() : '—';
                document.getElementById('detail-tenor').textContent = 
                    optionData.tenor ? optionData.tenor + ' years' : '—';
                document.getElementById('detail-grace').textContent = 
                    optionData.grace ? optionData.grace + ' years' : '—';
                document.getElementById('detail-rate').textContent = 
                    optionData.rate ? optionData.rate + '%' : '—';
                document.getElementById('detail-repayment').textContent = 
                    optionData.repayment_score ? optionData.repayment_score.toFixed(1) : '—';
                document.getElementById('detail-rate-score').textContent = 
                    optionData.rate_score ? optionData.rate_score.toFixed(1) : '—';
                document.getElementById('detail-total').textContent = 
                    optionData.total_score ? optionData.total_score.toFixed(1) : '—';
                document.getElementById('detail-pros').textContent = 
                    optionData.pros || 'Not specified';
                document.getElementById('detail-cons').textContent = 
                    optionData.cons || 'Not specified';
                
                drawer.classList.remove('hidden');
            });
        });
    }
    
    // Run Phase Button Handler
    const runBtn = document.getElementById("run-phase-btn");
    if (!runBtn) return;
    
    const caseId = runBtn.getAttribute("data-case-id");
    const phaseNo = runBtn.getAttribute("data-phase");
    
    function typeTextWords(element, fullText, wordDelay) {
        return new Promise((resolve) => {
            element.textContent = "";
            element.style.whiteSpace = "pre-line";
            const words = fullText.split(" ");
            let i = 0;
            function tick() {
                if (i < words.length) {
                    element.textContent += (i === 0 ? "" : " ") + words[i];
                    i++;
                    setTimeout(tick, wordDelay);
                } else {
                    resolve();
                }
            }
            tick();
        });
    }
    
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    runBtn.addEventListener("click", async () => {
        let thinkingCard = document.querySelector('.thinking-timeline')?.closest('.card');
        let stepsContainer = document.getElementById('thinking-timeline');
        
        if (!thinkingCard) {
            const emptyState = document.getElementById('thinking-empty');
            if (emptyState) emptyState.remove();
            
            thinkingCard = document.createElement('div');
            thinkingCard.className = 'card';
            thinkingCard.innerHTML = '<h3>Agent Reasoning</h3><div class="thinking-timeline" id="thinking-timeline"></div>';
            document.querySelector('.thinking-container').appendChild(thinkingCard);
            stepsContainer = thinkingCard.querySelector('.thinking-timeline');
        }
        
        const statusEl = document.getElementById("thinking-status");
        statusEl.textContent = "Starting phase " + phaseNo + " analysis...";
        statusEl.className = "thinking-status thinking-status-running";
        statusEl.classList.remove('hidden');
        stepsContainer.innerHTML = "";
        runBtn.disabled = true;
        runBtn.textContent = "Running...";
        
        try {
            const response = await fetch(`/api/cases/${caseId}/phases/${phaseNo}/run`, {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "Content-Type": "application/json"
                }
            });
            
            const data = await response.json();
            
            if (!response.ok || data.status !== "ok") {
                statusEl.textContent = "Error: " + (data.detail || "Phase execution failed");
                statusEl.className = "thinking-status thinking-status-error";
                runBtn.disabled = false;
                runBtn.textContent = "Run Phase " + phaseNo;
                showToast("Phase execution failed", "error");
                return;
            }
            
            const steps = data.thinking_steps || [];
            if (!steps.length) {
                statusEl.textContent = "Phase completed, but no thinking steps were returned.";
                runBtn.disabled = false;
                runBtn.textContent = "Run Phase " + phaseNo;
                return;
            }
            
            statusEl.textContent = "Agent reasoning...";
            
            const delayBeforeStep = 800;
            const wordDelay = 50;
            
            for (let idx = 0; idx < steps.length; idx++) {
                const stepObj = steps[idx];
                
                const stepDiv = document.createElement("div");
                stepDiv.classList.add("thinking-step", "thinking-step-streaming");
                stepDiv.style.opacity = "0";
                stepDiv.style.transform = "translateY(15px)";
                
                const headerDiv = document.createElement("div");
                headerDiv.classList.add("step-header");
                headerDiv.innerHTML = `
                    <span class="step-badge">Step ${stepObj.step || (idx + 1)}</span>
                    <strong>${stepObj.title || ""}</strong>
                `;
                
                const bodyDiv = document.createElement("div");
                bodyDiv.classList.add("step-description");
                bodyDiv.classList.add("typing-active");
                
                stepDiv.appendChild(headerDiv);
                stepDiv.appendChild(bodyDiv);
                stepsContainer.appendChild(stepDiv);
                
                await sleep(delayBeforeStep);
                
                stepDiv.style.transition = "opacity 0.5s ease-out, transform 0.5s ease-out";
                stepDiv.style.opacity = "1";
                stepDiv.style.transform = "translateY(0)";
                stepDiv.classList.add("thinking-step-visible");
                
                const fullText = stepObj.description || "";
                await typeTextWords(bodyDiv, fullText, wordDelay);
                
                bodyDiv.classList.remove("typing-active");
                bodyDiv.classList.add("typing-complete");
            }
            
            statusEl.textContent = "Phase " + phaseNo + " completed successfully.";
            statusEl.className = "thinking-status thinking-status-complete";
            
            showToast("Phase " + phaseNo + " completed successfully");
            
            runBtn.style.display = "none";
            
            const disabledProceed = document.getElementById("proceed-btn-disabled");
            if (disabledProceed) {
                const nextPhase = parseInt(phaseNo) + 1;
                const newBtn = document.createElement("a");
                if (nextPhase <= 4) {
                    newBtn.href = `/cases/${caseId}/phases/${nextPhase}`;
                    newBtn.textContent = `Proceed to Phase ${nextPhase} →`;
                } else {
                    newBtn.href = `/cases/${caseId}/review`;
                    newBtn.textContent = "Proceed to Review & Approve →";
                }
                newBtn.className = "btn btn-success";
                newBtn.id = "proceed-btn";
                disabledProceed.replaceWith(newBtn);
            }
            
            await sleep(1500);
            location.reload();
            
        } catch (err) {
            console.error(err);
            statusEl.textContent = "Unexpected error. Please try again.";
            statusEl.className = "thinking-status thinking-status-error";
            runBtn.disabled = false;
            runBtn.textContent = "Run Phase " + phaseNo;
            showToast("Unexpected error occurred", "error");
        }
    });
})();
</script>
{% endblock %}
