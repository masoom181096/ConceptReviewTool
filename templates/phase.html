{% extends "base.html" %}
{% from "_progress_bar.html" import phase_progress, phase_progress_vertical %}

{% macro display_val(value, suffix='', allow_zero=false) %}
  {% if value is not none and (value != 0 or allow_zero) %}
    {% if value is number %}
      {{ "{:,}".format(value|int) }}{% if suffix %} {{ suffix }}{% endif %}
    {% else %}
      {{ value }}{% if suffix %} {{ suffix }}{% endif %}
    {% endif %}
  {% else %}
    —
  {% endif %}
{% endmacro %}

{% block title %}Phase {{ phase_no }} - {{ phase_info[phase_no].title }} | {{ case.name }}{% endblock %}

{% block content %}
<div class="phase-layout">
    <!-- Left Sidebar -->
    <div class="phase-sidebar">
        <!-- Vertical Progress Bar -->
        {{ phase_progress_vertical(case, phase_no) }}
    </div>

    <!-- Main Content Area -->
    <div class="phase-main">
        <div class="phase-main-card">
            <div class="phase-title-section">
                <h2>Phase {{ phase_no }} – {{ phase_info[phase_no].title }}</h2>
                {% if phase_completed %}
                    <span class="status-pill status-completed">Completed</span>
                {% else %}
                    <span class="status-pill status-pending">Not Started</span>
                {% endif %}
            </div>
            
            <!-- Single Flow Container -->
            <div id="phase-flow">
                <!-- Inputs Summary Card -->
                <div class="card">
                    <h3>Inputs Summary</h3>
                    {% if phase_no == 1 %}
                    <p class="input-description">
                        The agent will parse the Sector Profile document, compare it with international benchmarks 
                        (Shenzhen, London, Santiago), and construct baseline KPIs for the pilot project.
                    </p>
                    {% if docs.sector_profile_filename %}
                        <p><strong>Document:</strong> {{ docs.sector_profile_filename }}</p>
                    {% elif docs.sector_profile_text %}
                        <p><strong>Document:</strong> Text input provided</p>
                        <div class="doc-preview">{{ docs.sector_profile_text[:300] }}{% if docs.sector_profile_text|length > 300 %}...{% endif %}</div>
                    {% else %}
                        <p class="warning-text">No sector profile document uploaded yet. <a href="/cases/{{ case.id }}">Upload documents</a></p>
                    {% endif %}
                    {% elif phase_no == 2 %}
                    <p class="input-description">
                        The agent will assess the project's sustainability characteristics using the uploaded 
                        sustainability document, including E&S classification, emissions reduction, and risk analysis.
                    </p>
                    {% if docs.sustainability_filename %}
                        <p><strong>Document:</strong> {{ docs.sustainability_filename }}</p>
                    {% elif docs.sustainability_text %}
                        <p><strong>Document:</strong> Text input provided</p>
                        <div class="doc-preview">{{ docs.sustainability_text[:300] }}{% if docs.sustainability_text|length > 300 %}...{% endif %}</div>
                    {% else %}
                        <p class="warning-text">No sustainability document uploaded yet. <a href="/cases/{{ case.id }}">Upload documents</a></p>
                    {% endif %}
                    {% elif phase_no == 3 %}
                    <p class="input-description">
                        This phase uses stubbed Bloomberg data and repayment heuristics to propose three 
                        financing structures with 60/40 scoring (60% repayment capacity, 40% rate competitiveness).
                    </p>
                    {% elif phase_no == 4 %}
                    <p class="input-description">
                        The agent will assemble all previous phase outputs into a comprehensive Concept Note 
                        draft for OPSComm review, summarizing the need, context, KPIs, financing options, 
                        and sustainability assessment.
                    </p>
                    {% endif %}
                </div>
                
                <!-- Thinking Status -->
                <div id="thinking-status" class="thinking-status hidden"></div>
                
                <!-- Thinking + Outputs Container (interleaved) -->
                <div id="thinking-outputs-container">
                    {% if thinking_steps %}
                    <!-- Show existing completed steps -->
                    {% for step in thinking_steps %}
                    <div class="thinking-step-card" data-step="{{ step.step }}">
                        <div class="thinking-step-header">
                            <div class="step-header-left">
                                <span class="step-badge">Step {{ step.step }}</span>
                                <strong>{{ step.title }}</strong>
                            </div>
                            <button type="button" class="toggle-reasoning-btn" data-expanded="false">Show reasoning</button>
                        </div>
                        <div class="thinking-step-body" style="display: none;">
                            <div class="step-description">{{ step.description|replace('\n', '<br>')|safe }}</div>
                        </div>
                        {% if step.sources %}
                        <div class="thinking-step-sources">
                            <span class="sources-label">Sources:</span>
                            {% for source in step.sources %}
                            <span class="source-item">{{ source }}{% if not loop.last %}, {% endif %}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Output block for this step -->
                    {% if phase_no == 1 %}
                        {% if step.step == 1 and sector_profile %}
                        <div class="output-block" data-step="1" id="output-sector-profile">
                            <div class="card">
                                <h3>Sector Profile</h3>
                                <table class="data-table">
                                    <tr><th>Total Fleet</th><td>{{ display_val(sector_profile.fleet_total, "buses") }}</td></tr>
                                    <tr><th>Diesel Buses</th><td>{{ display_val(sector_profile.fleet_diesel) }}</td></tr>
                                    <tr><th>Hybrid Buses</th><td>{{ display_val(sector_profile.fleet_hybrid) }}</td></tr>
                                    <tr><th>Electric Buses</th><td>{{ display_val(sector_profile.fleet_electric, '', true) }}</td></tr>
                                    <tr><th>Depots</th><td>{{ display_val(sector_profile.depots) }}</td></tr>
                                    <tr><th>Daily Ridership</th><td>{{ display_val(sector_profile.daily_ridership, "passengers/day") }}</td></tr>
                                    <tr><th>Annual OPEX</th><td>{% if sector_profile.annual_opex_usd %}${{ "{:,.0f}".format(sector_profile.annual_opex_usd) }}{% else %}—{% endif %}</td></tr>
                                    <tr><th>Annual CO2</th><td>{{ display_val(sector_profile.annual_co2_tons, "tons/year") }}</td></tr>
                                </table>
                                <div class="output-sources">
                                    <small>Sources (verification): {{ sector_profile_sources | join("; ") }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if step.step == 2 and gap_items %}
                        <div class="output-block" data-step="2" id="output-gap-analysis">
                            <div class="card">
                                <h3>Gap Analysis</h3>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Indicator</th>
                                            <th>{{ case.country }} Value</th>
                                            <th>Benchmark City</th>
                                            <th>Benchmark Value</th>
                                            <th>Gap</th>
                                            <th>Priority</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for gap in gap_items %}
                                        <tr>
                                            <td>{{ gap.indicator }}</td>
                                            <td>{{ gap.kenya_value or '—' }}</td>
                                            <td>{{ gap.benchmark_city or '—' }}</td>
                                            <td>{{ gap.benchmark_value or '—' }}</td>
                                            <td>{{ gap.gap_delta or '—' }}</td>
                                            <td><span class="priority-badge priority-{{ gap.comparability|lower }}">{{ gap.comparability }}</span></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <div class="output-sources">
                                    <small>Sources (verification): {{ gap_analysis_sources | join("; ") }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if step.step == 3 and kpis %}
                        <div class="output-block" data-step="3" id="output-kpis">
                            <div class="card">
                                <h3>Baseline KPIs</h3>
                                <table class="data-table" id="kpi-table">
                                    <thead>
                                        <tr>
                                            <th>KPI Name</th>
                                            <th>Baseline</th>
                                            <th>Target</th>
                                            <th>Unit</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for kpi in kpis %}
                                        <tr title="{{ kpi.notes or 'Key Performance Indicator: ' + kpi.name }}">
                                            <td>{{ kpi.name }}</td>
                                            <td>{{ kpi.baseline_value or '—' }}</td>
                                            <td>{{ kpi.target_value or '—' }}</td>
                                            <td>{{ kpi.unit or '—' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <div class="output-sources">
                                    <small>Sources (verification): {{ kpi_sources | join("; ") }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% elif phase_no == 2 %}
                        {% if step.step == 1 and sustainability %}
                        <div class="output-block" data-step="1" id="output-sustainability">
                            <div class="card">
                                <h3>Sustainability Profile</h3>
                                <table class="data-table">
                                    <tr>
                                        <th>E&S Category</th>
                                        <td>
                                            {% if sustainability.category %}
                                                <span class="category-badge category-{{ sustainability.category }}">Category {{ sustainability.category }}</span>
                                            {% else %}—{% endif %}
                                        </td>
                                    </tr>
                                    <tr><th>CO2 Reduction</th><td>{{ display_val(sustainability.co2_reduction_tons, "tons/year") }}</td></tr>
                                    <tr><th>PM2.5 Reduction</th><td>{{ sustainability.pm25_reduction or '—' }}</td></tr>
                                </table>
                                <div class="sustainability-details">
                                    <p><strong>Accessibility:</strong> {{ sustainability.accessibility_notes or '—' }}</p>
                                    <p><strong>Policy Alignment:</strong> {{ sustainability.policy_alignment_notes or '—' }}</p>
                                    <p><strong>Key Risks:</strong> {{ sustainability.key_risks or '—' }}</p>
                                    <p><strong>Mitigations:</strong> {{ sustainability.mitigations or '—' }}</p>
                                </div>
                                <div class="output-sources">
                                    <small>Sources (verification): {{ sustainability_sources | join("; ") }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% elif phase_no == 3 %}
                        {% if step.step == 1 %}
                        {% if market_data %}
                        <div class="output-block" data-step="1" id="output-market-data">
                            <div class="card">
                                <h3>Market Data Snapshot</h3>
                                <table class="data-table compact">
                                    <tr><th>EUR 10Y Swap</th><td>{{ market_data.eur_swap_10y_pct }}%</td></tr>
                                    <tr><th>Green Bond Spread (10Y)</th><td>{{ market_data.green_bond_spread_10y_pct }}%</td></tr>
                                    <tr><th>All-in Green Rate</th><td>{{ market_data.all_in_green_rate_pct }}%</td></tr>
                                </table>
                                <div class="output-sources">
                                    <small>Sources (verification): {{ market_data_sources | join("; ") }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if financial_options %}
                        <div class="output-block output-block-combined" data-step="1" id="output-financial-options">
                            <div class="card">
                                <h3>Financial Options</h3>
                                <p class="input-description">Click on a row to view detailed information about each financing option.</p>
                                <table class="data-table financial-options-table table-clickable" id="financial-options-table">
                                    <thead>
                                        <tr>
                                            <th>Option</th>
                                            <th>Structure</th>
                                            <th>Tenor/Grace</th>
                                            <th>Rate</th>
                                            <th>Repayment Score</th>
                                            <th>Rate Score</th>
                                            <th>Total Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for opt in financial_options %}
                                        <tr data-option-json='{{ {"name": opt.name, "principal": opt.principal_amount_usd, "tenor": opt.tenor_years, "grace": opt.grace_period_years, "rate": (opt.all_in_rate_bps / 100)|round(2) if opt.all_in_rate_bps else null, "repayment_score": opt.repayment_score|round(1) if opt.repayment_score else null, "rate_score": opt.rate_score|round(1) if opt.rate_score else null, "total_score": opt.total_score|round(1) if opt.total_score else null, "pros": opt.pros, "cons": opt.cons}|tojson }}'>
                                            <td><strong>Option {{ loop.index | string | replace('1', 'A') | replace('2', 'B') | replace('3', 'C') }}</strong></td>
                                            <td>{{ opt.name }}</td>
                                            <td>{{ opt.tenor_years or '—' }}y / {{ opt.grace_period_years or '—' }}y</td>
                                            <td>{% if opt.all_in_rate_bps %}{{ (opt.all_in_rate_bps / 100)|round(2) }}%{% else %}—{% endif %}</td>
                                            <td>{{ opt.repayment_score|round(1) if opt.repayment_score else '—' }}</td>
                                            <td>{{ opt.rate_score|round(1) if opt.rate_score else '—' }}</td>
                                            <td><strong>{{ opt.total_score|round(1) if opt.total_score else '—' }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                
                                <!-- Option Detail Drawer -->
                                <div id="option-detail-drawer" class="option-detail-card hidden">
                                    <h4 id="option-detail-title">Option Details</h4>
                                    <div class="option-detail-grid">
                                        <div class="option-detail-item">
                                            <div class="label">Principal Amount</div>
                                            <div class="value" id="detail-principal">—</div>
                                        </div>
                                        <div class="option-detail-item">
                                            <div class="label">Tenor</div>
                                            <div class="value" id="detail-tenor">—</div>
                                        </div>
                                        <div class="option-detail-item">
                                            <div class="label">Grace Period</div>
                                            <div class="value" id="detail-grace">—</div>
                                        </div>
                                        <div class="option-detail-item">
                                            <div class="label">Interest Rate</div>
                                            <div class="value" id="detail-rate">—</div>
                                        </div>
                                        <div class="option-detail-item">
                                            <div class="label">Repayment Score</div>
                                            <div class="value" id="detail-repayment">—</div>
                                        </div>
                                        <div class="option-detail-item">
                                            <div class="label">Rate Score</div>
                                            <div class="value" id="detail-rate-score">—</div>
                                        </div>
                                        <div class="option-detail-item">
                                            <div class="label">Total Score</div>
                                            <div class="value" id="detail-total">—</div>
                                        </div>
                                    </div>
                                    <div class="option-pros-cons-grid">
                                        <div class="option-pros-section">
                                            <h5>Benefits</h5>
                                            <p id="detail-pros">—</p>
                                        </div>
                                        <div class="option-cons-section">
                                            <h5>Trade-offs</h5>
                                            <p id="detail-cons">—</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="output-sources">
                                    <small>Sources (verification): {{ market_data_sources | join("; ") }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                    {% elif phase_no == 4 %}
                        {% if step.step == 1 and concept_note_html %}
                        <div class="output-block" data-step="1" id="output-concept-note">
                            <div class="card concept-note-preview">
                                <h3>Concept Note Preview</h3>
                                <div class="concept-note-content">
                                    {{ concept_note_html|safe }}
                                </div>
                                <div class="output-sources">
                                    <small>Sources (verification): {{ concept_note_sources | join("; ") }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <!-- Empty state when no thinking steps yet -->
                    <div class="thinking-empty-state" id="thinking-empty">
                        <p>No agent reasoning recorded yet.</p>
                        {% set prev_phase_completed = (phase_no == 1) or (phase_no == 2 and case.phase1_completed) or (phase_no == 3 and case.phase2_completed) or (phase_no == 4 and case.phase3_completed) %}
                        {% if not phase_completed and prev_phase_completed %}
                        <p>Click "Run Phase {{ phase_no }}" to start the analysis.</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Hidden Output Blocks for Dynamic Reveal (used when phase runs) -->
                {% if phase_no == 1 %}
                <div class="output-block hidden-output" data-step="1" id="dynamic-output-sector-profile" style="display:none;">
                    <div class="card">
                        <h3>Sector Profile</h3>
                        <div class="dynamic-output-content">Loading...</div>
                    </div>
                </div>
                <div class="output-block hidden-output" data-step="2" id="dynamic-output-gap-analysis" style="display:none;">
                    <div class="card">
                        <h3>Gap Analysis</h3>
                        <div class="dynamic-output-content">Loading...</div>
                    </div>
                </div>
                <div class="output-block hidden-output" data-step="3" id="dynamic-output-kpis" style="display:none;">
                    <div class="card">
                        <h3>Baseline KPIs</h3>
                        <div class="dynamic-output-content">Loading...</div>
                    </div>
                </div>
                {% elif phase_no == 2 %}
                <div class="output-block hidden-output" data-step="1" id="dynamic-output-sustainability" style="display:none;">
                    <div class="card">
                        <h3>Sustainability Profile</h3>
                        <div class="dynamic-output-content">Loading...</div>
                    </div>
                </div>
                {% elif phase_no == 3 %}
                <div class="output-block hidden-output" data-step="1" id="dynamic-output-market-financial" style="display:none;">
                    <div class="card">
                        <h3>Market Data & Financial Options</h3>
                        <div class="dynamic-output-content">Loading...</div>
                    </div>
                </div>
                {% elif phase_no == 4 %}
                <div class="output-block hidden-output" data-step="1" id="dynamic-output-concept-note" style="display:none;">
                    <div class="card">
                        <h3>Concept Note Preview</h3>
                        <div class="dynamic-output-content">Loading...</div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Run Phase Action -->
                {% set prev_phase_completed = (phase_no == 1) or (phase_no == 2 and case.phase1_completed) or (phase_no == 3 and case.phase2_completed) or (phase_no == 4 and case.phase3_completed) %}
                {% if prev_phase_completed %}
                <div class="run-phase-action">
                    <button 
                        id="run-phase-btn" 
                        type="button" 
                        class="btn btn-primary btn-large"
                        data-case-id="{{ case.id }}"
                        data-phase="{{ phase_no }}"
                        data-auto-run="{{ 'true' if auto_run_phase else 'false' }}"
                    >
                        {% if phase_completed %}
                            Re-run Phase {{ phase_no }}
                        {% else %}
                            Run Phase {{ phase_no }}
                        {% endif %}
                    </button>
                </div>
                {% else %}
                <div class="run-phase-action">
                    <span class="btn btn-disabled">Complete Phase {{ phase_no - 1 }} first</span>
                </div>
                {% endif %}
            </div>
            
            <!-- Phase Navigation Footer -->
            <div class="phase-footer">
                <div class="phase-footer-left">
                    <a href="/cases/{{ case.id }}" class="back-link">&larr; Back to Case Overview</a>
                </div>
                <div class="phase-footer-right">
                    {% if phase_no > 1 %}
                        <a href="/cases/{{ case.id }}/phases/{{ phase_no - 1 }}" class="btn btn-secondary">&larr; Phase {{ phase_no - 1 }}</a>
                    {% endif %}
                    
                    {% if phase_no < 4 %}
                        {% if phase_completed %}
                            <a href="/cases/{{ case.id }}/phases/{{ phase_no + 1 }}" class="btn btn-success" id="proceed-btn">Proceed to Phase {{ phase_no + 1 }} &rarr;</a>
                        {% else %}
                            <button type="button" class="btn btn-disabled" id="proceed-btn-disabled" disabled title="Run this phase first">Proceed to Phase {{ phase_no + 1 }} &rarr;</button>
                        {% endif %}
                    {% else %}
                        {% if phase_completed %}
                            <a href="/cases/{{ case.id }}/review" class="btn btn-success" id="proceed-btn">Review & Approve &rarr;</a>
                        {% else %}
                            <button type="button" class="btn btn-disabled" id="proceed-btn-disabled" disabled title="Run this phase first">Review & Approve &rarr;</button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<script>
(function() {
    // Toast Notification System
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        
        const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
        toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 2500);
    }
    
    window.showToast = showToast;
    
    // Toggle reasoning button handlers (for already-loaded steps)
    function setupToggleHandlers() {
        document.querySelectorAll('.toggle-reasoning-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const card = this.closest('.thinking-step-card');
                const body = card.querySelector('.thinking-step-body');
                const isExpanded = this.getAttribute('data-expanded') === 'true';
                
                if (isExpanded) {
                    body.style.display = 'none';
                    this.textContent = 'Show reasoning';
                    this.setAttribute('data-expanded', 'false');
                } else {
                    body.style.display = 'block';
                    this.textContent = 'Hide reasoning';
                    this.setAttribute('data-expanded', 'true');
                }
            });
        });
    }
    
    setupToggleHandlers();
    
    // Financial Options Interactive Table (Phase 3)
    const optionsTable = document.getElementById('financial-options-table');
    if (optionsTable) {
        const rows = optionsTable.querySelectorAll('tbody tr');
        const drawer = document.getElementById('option-detail-drawer');
        
        rows.forEach((row, idx) => {
            row.addEventListener('click', () => {
                rows.forEach(r => r.classList.remove('row-selected'));
                row.classList.add('row-selected');
                
                const optionData = JSON.parse(row.getAttribute('data-option-json'));
                
                const optionLetter = ['A', 'B', 'C'][idx] || (idx + 1);
                document.getElementById('option-detail-title').textContent = 
                    'Option ' + optionLetter + ': ' + (optionData.name || 'Details');
                
                document.getElementById('detail-principal').textContent = 
                    optionData.principal ? '$' + optionData.principal.toLocaleString() : '—';
                document.getElementById('detail-tenor').textContent = 
                    optionData.tenor ? optionData.tenor + ' years' : '—';
                document.getElementById('detail-grace').textContent = 
                    optionData.grace ? optionData.grace + ' years' : '—';
                document.getElementById('detail-rate').textContent = 
                    optionData.rate ? optionData.rate + '%' : '—';
                document.getElementById('detail-repayment').textContent = 
                    optionData.repayment_score ? optionData.repayment_score.toFixed(1) : '—';
                document.getElementById('detail-rate-score').textContent = 
                    optionData.rate_score ? optionData.rate_score.toFixed(1) : '—';
                document.getElementById('detail-total').textContent = 
                    optionData.total_score ? optionData.total_score.toFixed(1) : '—';
                document.getElementById('detail-pros').textContent = 
                    optionData.pros || 'Not specified';
                document.getElementById('detail-cons').textContent = 
                    optionData.cons || 'Not specified';
                
                drawer.classList.remove('hidden');
            });
        });
    }
    
    // Run Phase Button Handler
    const runBtn = document.getElementById("run-phase-btn");
    if (!runBtn) return;
    
    const caseId = runBtn.getAttribute("data-case-id");
    const phaseNo = runBtn.getAttribute("data-phase");
    const autoRun = runBtn.getAttribute("data-auto-run") === "true";
    const originalButtonText = runBtn.textContent.trim();
    
    function typeTextWords(element, fullText, wordDelay) {
        return new Promise((resolve) => {
            element.textContent = "";
            element.style.whiteSpace = "pre-line";
            const words = fullText.split(" ");
            let i = 0;
            function tick() {
                if (i < words.length) {
                    element.textContent += (i === 0 ? "" : " ") + words[i];
                    i++;
                    setTimeout(tick, wordDelay);
                } else {
                    resolve();
                }
            }
            tick();
        });
    }
    
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    function renderSources(sources) {
        if (!sources || sources.length === 0) return '';
        const sourceItems = sources.map(s => `<span class="source-item">${s}</span>`).join(', ');
        return `<div class="thinking-step-sources"><span class="sources-label">Sources:</span> ${sourceItems}</div>`;
    }
    
    async function runPhase() {
        const container = document.getElementById('thinking-outputs-container');
        
        // Clear existing content
        const emptyState = document.getElementById('thinking-empty');
        if (emptyState) emptyState.remove();
        
        // Remove any existing step cards and outputs for re-run
        container.querySelectorAll('.thinking-step-card, .output-block:not(.hidden-output)').forEach(el => el.remove());
        
        const statusEl = document.getElementById("thinking-status");
        statusEl.textContent = "Starting phase " + phaseNo + " analysis...";
        statusEl.className = "thinking-status thinking-status-running";
        statusEl.classList.remove('hidden');
        runBtn.disabled = true;
        runBtn.textContent = "Running...";
        
        try {
            const response = await fetch(`/api/cases/${caseId}/phases/${phaseNo}/run`, {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "Content-Type": "application/json"
                }
            });
            
            const data = await response.json();
            
            if (!response.ok || data.status !== "ok") {
                statusEl.textContent = "Error: " + (data.detail || "Phase execution failed");
                statusEl.className = "thinking-status thinking-status-error";
                runBtn.disabled = false;
                runBtn.textContent = originalButtonText;
                showToast("Phase execution failed", "error");
                return;
            }
            
            const steps = data.thinking_steps || [];
            if (!steps.length) {
                statusEl.textContent = "Phase completed, but no thinking steps were returned.";
                runBtn.disabled = false;
                runBtn.textContent = "Re-run Phase " + phaseNo;
                return;
            }
            
            statusEl.textContent = "Agent reasoning...";
            
            const delayBeforeStep = 800;
            const wordDelay = 50;
            
            for (let idx = 0; idx < steps.length; idx++) {
                const stepObj = steps[idx];
                const stepNum = stepObj.step || (idx + 1);
                
                // Create thinking step card
                const stepCard = document.createElement("div");
                stepCard.classList.add("thinking-step-card");
                stepCard.setAttribute("data-step", stepNum);
                stepCard.style.opacity = "0";
                stepCard.style.transform = "translateY(15px)";
                
                // Header with toggle button
                const headerDiv = document.createElement("div");
                headerDiv.classList.add("thinking-step-header");
                headerDiv.innerHTML = `
                    <div class="step-header-left">
                        <span class="step-badge">Step ${stepNum}</span>
                        <strong>${stepObj.title || ""}</strong>
                    </div>
                    <button type="button" class="toggle-reasoning-btn" data-expanded="true">Hide reasoning</button>
                `;
                
                // Body (reasoning text)
                const bodyDiv = document.createElement("div");
                bodyDiv.classList.add("thinking-step-body");
                
                const descDiv = document.createElement("div");
                descDiv.classList.add("step-description", "typing-active");
                
                bodyDiv.appendChild(descDiv);
                
                stepCard.appendChild(headerDiv);
                stepCard.appendChild(bodyDiv);
                container.appendChild(stepCard);
                
                // Add toggle handler
                const toggleBtn = headerDiv.querySelector('.toggle-reasoning-btn');
                toggleBtn.addEventListener('click', function() {
                    const isExpanded = this.getAttribute('data-expanded') === 'true';
                    if (isExpanded) {
                        bodyDiv.style.display = 'none';
                        this.textContent = 'Show reasoning';
                        this.setAttribute('data-expanded', 'false');
                    } else {
                        bodyDiv.style.display = 'block';
                        this.textContent = 'Hide reasoning';
                        this.setAttribute('data-expanded', 'true');
                    }
                });
                
                await sleep(delayBeforeStep);
                
                // Animate in
                stepCard.style.transition = "opacity 0.5s ease-out, transform 0.5s ease-out";
                stepCard.style.opacity = "1";
                stepCard.style.transform = "translateY(0)";
                
                // Typewriter effect
                const fullText = stepObj.description || "";
                await typeTextWords(descDiv, fullText, wordDelay);
                
                descDiv.classList.remove("typing-active");
                descDiv.classList.add("typing-complete");
                
                // Add sources after typing
                if (stepObj.sources && stepObj.sources.length > 0) {
                    const sourcesDiv = document.createElement("div");
                    sourcesDiv.className = "thinking-step-sources";
                    sourcesDiv.innerHTML = `<span class="sources-label">Sources:</span> ${stepObj.sources.map(s => `<span class="source-item">${s}</span>`).join(', ')}`;
                    stepCard.appendChild(sourcesDiv);
                }
                
                // Collapse the reasoning body
                await sleep(500);
                bodyDiv.style.display = 'none';
                toggleBtn.textContent = 'Show reasoning';
                toggleBtn.setAttribute('data-expanded', 'false');
                
                // Reveal the associated output block
                const outputBlock = document.querySelector(`.hidden-output[data-step="${stepNum}"]`);
                if (outputBlock) {
                    outputBlock.style.display = 'block';
                    outputBlock.classList.remove('hidden-output');
                    outputBlock.style.opacity = '0';
                    outputBlock.style.transform = 'translateY(10px)';
                    
                    // Move it after the step card
                    container.appendChild(outputBlock);
                    
                    await sleep(200);
                    outputBlock.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
                    outputBlock.style.opacity = '1';
                    outputBlock.style.transform = 'translateY(0)';
                }
                
                await sleep(300);
            }
            
            statusEl.textContent = "Phase " + phaseNo + " completed successfully.";
            statusEl.className = "thinking-status thinking-status-complete";
            
            showToast("Phase " + phaseNo + " completed successfully");
            
            runBtn.style.display = "none";
            
            const disabledProceed = document.getElementById("proceed-btn-disabled");
            if (disabledProceed) {
                const nextPhase = parseInt(phaseNo) + 1;
                const newBtn = document.createElement("a");
                if (nextPhase <= 4) {
                    newBtn.href = `/cases/${caseId}/phases/${nextPhase}`;
                    newBtn.textContent = `Proceed to Phase ${nextPhase} →`;
                } else {
                    newBtn.href = `/cases/${caseId}/review`;
                    newBtn.textContent = "Proceed to Review & Approve →";
                }
                newBtn.className = "btn btn-success";
                newBtn.id = "proceed-btn";
                disabledProceed.replaceWith(newBtn);
            }
            
            await sleep(1500);
            location.reload();
            
        } catch (err) {
            console.error(err);
            statusEl.textContent = "Unexpected error. Please try again.";
            statusEl.className = "thinking-status thinking-status-error";
            runBtn.disabled = false;
            runBtn.textContent = originalButtonText;
            showToast("Unexpected error occurred", "error");
        }
    }
    
    // Manual run/re-run via button click
    runBtn.addEventListener("click", () => {
        runPhase();
    });
    
    // Auto-run on page load if phase not completed
    if (autoRun) {
        setTimeout(() => {
            runPhase();
        }, 500);
    }
})();
</script>
{% endblock %}
