üîß Replit Prompt ‚Äì Streaming-style Agent Thinking + Multi-Option Concept Note
I already have a working Concept Review Tool built with:
FastAPI + Jinja2 + SQLite + SQLAlchemy
Email-first intake and EML/MSG parsing with auto-attachment handling
Case detail page that lets me upload Sector Profile and Sustainability documents
A run_concept_review_for_case orchestrator agent in agents/concept_review_orchestrator.py
Financial options generated in agents/financial_structuring_agent.py
A Concept Note generated in agents/concept_note_agent.py
Right now:
The agent thinking appears ‚Äúall at once‚Äù after the HTTP request finishes.
The Concept Note only effectively shows one financial instrument (usually the best-scored option), instead of a choice with trade-offs.
I want you to make two major enhancements:
Streaming-style, step-by-step ‚Äúthinking‚Äù UI, to mimic an LLM running sequentially.
Concept Note section with all 3 financial options, including benefits and trade-offs for each.
1. Streaming-style Agent Thinking (LLM-like)
1.1 Backend ‚Äì JSON endpoint for orchestrator
Right now I probably have a route like POST /cases/{case_id}/run_concept_review that:
Runs run_concept_review_for_case(case, case_docs) synchronously,
Writes entities + Concept Note to DB,
Redirects back to the case page.
I want a new JSON endpoint that I can call with fetch() from the browser.
Add a new route in main.py (or the router file):
from fastapi import APIRouter, Request
from fastapi.responses import JSONResponse
@app.post("/api/cases/{case_id}/run_concept_review")
async def api_run_concept_review(case_id: int):
    """
    API endpoint: run the Concept Review orchestrator and return:
      - thinking_steps (list of dicts)
      - concept_note_markdown (string)
    It should ALSO persist the structured entities & ConceptNote to the DB, just like the old route.
    """
In this route:
Load Case and CaseDocuments from the DB.
Call run_concept_review_for_case(case, case_docs) from agents/concept_review_orchestrator.py.
The orchestrator should already be returning a dict like:
Save / update entities in the DB exactly as before (SectorProfile, GapAnalysisItem, BaselineKPI, FinancialOption, SustainabilityProfile, ConceptNote).
Return a JSONResponse with:
(If the orchestrator currently doesn‚Äôt return thinking_steps, add it as described in the earlier prompt and wire it through.)
Keep the old non-JSON route if you want, but the new behavior should use this /api/... endpoint.
1.2 Frontend ‚Äì LLM-like thinking animation
I want the Case detail page to behave like this:
When I click a button ‚ÄúRun Concept Review Agent‚Äù,
A ‚Äúthinking‚Äù panel appears,
Steps appear one by one, with a small delay between them (e.g. 1‚Äì2 seconds),
Text fades in or ‚Äútypes in‚Äù gradually, to mimic an LLM streaming output,
When all steps are shown, I can refresh the Concept Note / entity tables.
Implementation in case_detail.html:
Add a ‚ÄúRun Agent‚Äù button that does not submit a full page form; instead it triggers JS.
Add a container for thinking steps:
Add a <script> block at the bottom of the template that:
Attaches a click handler to #run-agent-btn.
Uses fetch("/api/cases/{{ case.id }}/run_concept_review", { method: "POST" }).
On response JSON, reads thinking_steps (list of {step, title, description}) and concept_note_markdown.
Add minimal CSS for .thinking-step (e.g. border, padding, etc.) to make the transition visible.
Important: The actual computation still runs synchronously on the backend and returns all steps at once. The ‚Äúthinking‚Äù delay is implemented in the frontend, which is perfectly fine for this PoC and visually matches the LLM experience.
If you want tiny pauses server-side as well, you can add await asyncio.sleep(0.3) between steps inside the orchestrator, but do not block too long; the user will already perceive delay because of the frontend animation.
2. Concept Note ‚Äì Multiple Financial Options with Trade-offs
You mentioned the Concept Note only showed one financial instrument. I want all 3 options, with explicit benefits / trade-offs, in the Concept Note.
2.1 Financial Agent ‚Äì pros/cons for each option
In agents/financial_structuring_agent.py, ensure that build_financial_options(...) returns at least three options in a list, each with:
name (e.g., "Option A ‚Äì Sovereign Loan"),
instrument_type,
tenor_years, grace_period_years, currency,
all_in_rate_bps,
principal_amount_usd,
repayment_score, rate_score, total_score,
pros (short text, e.g., ‚ÄúSimplest structure, aligned with existing sovereign lending framework.‚Äù),
cons (short text, e.g., ‚ÄúHigher FX risk; limited scope for local capital market development.‚Äù).
If currently you only set pros/cons for one option or not at all, add them explicitly for all three.
2.2 Concept Note Agent ‚Äì include all options
In agents/concept_note_agent.py, the function
generate_concept_note(case, need_summary, sector_profile, gaps, kpis, options, sustainability) -> str should be updated.
Ensure the function receives the full list of financial options, not only the ‚Äúbest‚Äù one. If it is currently picking just options[0], change it to iterate.
In the Concept Note markdown, make a dedicated section:
## 6. Financing Options and Trade-offs
The following financing structures have been identified for this project. Scores are based on a 60/40 weighting of repayment capacity and interest rate attractiveness.
| Option | Structure | Tenor / Grace | All-in Rate | Total Score | Key Benefits | Key Trade-offs |
|-------|-----------|---------------|-------------|-------------|--------------|----------------|
| A | ... | ... | ... | ... | ... | ... |
| B | ... | ... | ... | ... | ... | ... |
| C | ... | ... | ... | ... | ... | ... |
For each FinancialOption in options (sorted by total_score descending), populate the table row with:
Option label (A/B/C) derived by index (chr(ord('A') + idx)),
name or instrument_type + key structural features,
tenor_years / grace_period_years,
All-in rate as a percentage (e.g., all_in_rate_bps / 100 with 2 decimals),
total_score rounded (e.g., 1 decimal),
pros,
cons.
After the table, add a short narrative that explicitly frames this as a choice, not a single recommendation, for example:
Based on the scoring, Option {{best_option_label}} currently ranks highest. However:
- Option A prioritises lower interest cost but concentrates risk on the sovereign balance sheet.
- Option B balances sovereign support with operational responsibility at the city authority level.
- Option C is more expensive but could support local capital market development and crowd-in private investors.
OPSComm is invited to select the most appropriate option or request a variation based on policy and risk considerations.
Use the actual pros/cons fields to generate this narrative in a deterministic way (simple string concatenation), not via an LLM.
2.3 Concept Note view/template
If concept_note.html currently just displays ConceptNote.content_markdown rendered as HTML, you don‚Äôt need changes there‚Äîonce the markdown includes the full table, it will show all options.
Optionally:
In the Case detail page, add a ‚ÄúView Concept Note‚Äù button that opens /cases/{case_id}/concept_note in a new tab so that, after watching the thinking animation, the user can immediately see the updated note.
3. Sanity checks
After implementing all this, I should be able to:
Upload email + attachments, create a case, ensure Sector/Sustainability text is prefilled.
On the Case detail page, click ‚ÄúRun Concept Review Agent‚Äù:
See the agent thinking panel appear.
Watch steps appear one by one, with ~1‚Äì2 seconds between them, fading in.
Once thinking is done:
Reload the Concept Note view and see a Financing Options section with three options in a table, each with:
structure details,
all-in rate,
total score,
benefits and trade-offs.
Confirm the DB still stores:
all FinancialOption rows,
updated ConceptNote content,
nothing else breaks.
Please implement these changes cleanly, with comments noting that:
The ‚Äúthinking delay‚Äù is simulated in the frontend for UX realism,
All external data (benchmarks, Bloomberg) are still stubbed and derived from the static information I provided.
<section id="agent-thinking-section" style="display:none; margin-top: 1rem;">
  <h3>Agent Thinking...</h3>
  <div id="thinking-steps"></div>
</section>
<button id="run-agent-btn" type="button">Run Concept Review Agent</button>
{
  "thinking_steps": [...],
  "concept_note_markdown": "...",
  "success": true
}
{
    "sector_profile": ...,
    "gap_items": [...],
    "kpis": [...],
    "financial_options": [...],
    "sustainability_profile": ...,
    "concept_note_content": "...",  # markdown
    "thinking_steps": [...],        # list of {step, title, description}
}